{% extends "base.html" %}
{% block content %}
<div class="dont-montserrat container mx-auto p-6 space-y-8">

  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <div class="bg-white rounded-2xl shadow-lg p-6 text-center">
      <h2 class="text-2xl font-bold text-gray-700 shadow-sm">Total Investido</h2>
      <p class="font-red-rose text-4xl font-semibold text-green-600 mt-4">R$ {{ total_investido | compacto }}</p>
    </div>

    <div class="bg-white rounded-2xl shadow-lg p-6 text-center">
      <h2 class="text-2xl font-bold text-gray-700 shadow-sm">Total de Contas</h2>
      <p class="font-red-rose text-4xl font-semibold text-blue-500 mt-4">{{ total_contas | compacto }}</p>
    </div>

    <div class="bg-white rounded-2xl shadow-lg p-6 text-center">
      <h2 class="text-2xl font-bold text-gray-700 shadow-sm">Total de Pessoas</h2>
      <p class="font-red-rose text-4xl font-semibold text-purple-500 mt-4">{{ total_pessoas | compacto }}</p>
    </div>
  </div>

  <div class="bg-white rounded-2xl shadow-lg p-6">
    <h2 class="text-xl font-bold text-gray-700 mb-4 shadow-sm">Previsão de Rendimento dos Investimentos dos Últimos 12 Meses</h2>
    <div class="flex items-center gap-4 mb-4">
      <label for="tipoInvestimento" class="text-gray-700 font-semibold">Filtrar por tipo:</label>
      <select id="tipoInvestimento" class="border rounded px-3 py-2 text-sm"
              onchange="location.href = '/dashboard?tipoInvestimento=' + this.value;">
        <option value="AMBOS" {% if request.args.get('tipoInvestimento') == 'AMBOS' %}selected{% endif %}>Ambas</option>
        <option value="FIXA" {% if request.args.get('tipoInvestimento') == 'FIXA' %}selected{% endif %}>Renda Fixa</option>
        <option value="VARIAVEL" {% if request.args.get('tipoInvestimento') == 'VARIAVEL' %}selected{% endif %}>Renda Variável</option>
      </select>
    </div>
    <div id="graficoRendimento" class="w-full max-w-4xl h-96 mx-auto"></div>
  </div>

  <div class="bg-white rounded-2xl shadow-lg p-6">
    <h2 class="text-xl font-bold text-gray-700 mb-4 shadow-sm">Últimas Ordens de Investimentos</h2>
    <div class="overflow-x-auto">
      <table class="table-auto w-full text-left text-sm text-gray-600">
        <thead class="bg-gray-100 text-xs uppercase text-gray-700">
          <tr>
            <th class="px-4 py-2">Conta</th>
            <th class="px-4 py-2">Investimento</th>
            <th class="px-4 py-2">Quantia Investida</th>
            <th class="px-4 py-2">Data</th>
          </tr>
        </thead>
        <tbody>
          {% for ordem in ultimas_ordens %}
          <tr class="border-b hover:bg-gray-50">
            <td class="px-4 py-2">{{ ordem.conta }}</td>
            <td class="px-4 py-2">{{ ordem.investimento }}</td>
            <td class="px-4 py-2">R$ {{ "%.2f"|format(ordem.quantia) }}</td>
            <td class="px-4 py-2">{{ ordem.data }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
  const options = {
    chart: {
      type: 'area',
      height: 380,
      toolbar: {
        show: false
      }
    },
    series: [{
      name: 'Rendimento Acumulado',
      data: {{ rendimentos | default([]) | tojson }}
    }],
    xaxis: {
      categories: {{ datas | default([]) | tojson }},
      title: {
        text: 'Mês'
      }
    },
    yaxis: {
      title: {
        text: 'R$'
      },
      labels: {
        formatter: function (value) {
          if (value >= 1_000_000_000) return 'R$ ' + (value / 1_000_000_000).toFixed(1) + 'B';
          if (value >= 1_000_000) return 'R$ ' + (value / 1_000_000).toFixed(1) + 'M';
          if (value >= 1_000) return 'R$ ' + (value / 1_000).toFixed(1) + 'K';
          return 'R$ ' + value.toFixed(2);
        }
      }
    },
    tooltip: {
      y: {
        formatter: function (value) {
          if (value >= 1_000_000_000) return 'R$ ' + (value / 1_000_000_000).toFixed(1) + 'B';
          if (value >= 1_000_000) return 'R$ ' + (value / 1_000_000).toFixed(1) + 'M';
          if (value >= 1_000) return 'R$ ' + (value / 1_000).toFixed(1) + 'K';
          return 'R$ ' + value.toFixed(2);
        }
      }
    },
    dataLabels: {
      enabled: true,
      formatter: function(value) {
        if (value >= 1_000_000_000) return (value / 1_000_000_000).toFixed(1) + 'B';
        if (value >= 1_000_000) return (value / 1_000_000).toFixed(1) + 'M';
        if (value >= 1_000) return (value / 1_000).toFixed(1) + 'K';
        return value.toFixed(0);
      },
      style: {
        colors: ['#ffffff']  // texto branco (para contraste com fundo verde)
      },
      background: {
        enabled: true,
        foreColor: '#22c55e', // cor verde do background do rótulo
        borderRadius: 4,
        padding: 4,
        opacity: 0.9,
      }
    },
    colors: ['#22c55e']
  };

  const chart = new ApexCharts(document.querySelector("#graficoRendimento"), options);
  chart.render();
</script>
<script>
  function atualizarGrafico() {
    const tipo = document.getElementById("tipoInvestimento").value;

    fetch(`/rendimento-dinamico?tipo=${tipo}`)
      .then(response => response.json())
      .then(data => {
        chart.updateOptions({
          xaxis: {
            categories: data.datas
          },
          series: [{
            name: 'Rendimento Acumulado',
            data: data.rendimentos
          }]
        });
      })
      .catch(error => console.error("Erro ao carregar dados:", error));
  }
</script>
{% endblock %}